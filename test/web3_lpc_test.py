from web3 import Web3
from web3.middleware import geth_poa_middleware
import solcx
import pathlib
from web3_test_defs import contracts_dir
from web3_test import find_compiled_contract, print_tx_info

w3 = Web3(Web3.HTTPProvider('http://127.0.0.1:8545'))
w3.middleware_onion.inject(geth_poa_middleware, layer=0)
w3.eth.default_account = w3.eth.accounts[0]

contract_name = 'TestLpcVerifier'

def init_test1():
    params = dict()
    params['_test_name'] = "Batched lpc verification (case 1)"
    params['proof'] = '0x000000000000002034440d6630f9846b27bc05a32f3390d9b84831d6a1e98df9396ba8fc49acecd70000000000000001000000000000000100000000000000000000000000000000000000000000000000000522cc1bdd94000000000000000200000000000000010000000000000002140ed5b5c795283c66164f3c886cbf969fb9c615483eafef8d8cc2fbcbc3de633dbfdc991d20217983afdda8fe7c68f79188b5f6c4d345ba75f27fea3ed527700000000000000003000000000000000112b087a4e0e901a55d17a1c70f873be6caf042998a07ff674e47fcf7f45e0ea3000000000000002034440d6630f9846b27bc05a32f3390d9b84831d6a1e98df9396ba8fc49acecd70000000000000002000000000000000123546505647e19581708d7d8ef9e5ef083afe699fff36cadf640cce8db9af21e00000000000000015a69273aee19dc15fc4d86fd5d1bc69422c898839a40e375a81526c424ac510800000000000000010000000000000020a74de21bd53d526f56e1b72cb5e9fd6b3552f4328478db514f3af23afe85290a0000000000000003000000000000000100000000000000000000000000000020d4d989de60f96bdc78c34eaefd8541dd578ec961901dfe38406c49995dd2a5a20000000000000001000000000000000100000000000000202549fb1684d4201e9b196ef91e45a909f817f164f214dd3219280dc46f0a22c200000000000000010000000000000001000000000000002085013d1f2744c0da4ecc4fd4bbe969efcb0f7f9a742415184e1408c3045cbf7300000000000000020000000000000001000000000000002034440d6630f9846b27bc05a32f3390d9b84831d6a1e98df9396ba8fc49acecd70000000000000004000000000000000100000000000000000000000000000020c6bb06cb7f92603de181bf256cd16846b93b752a170ff24824098b31aa008a7e0000000000000001000000000000000100000000000000204378ff515889172eba22524c734480b058f489537071dd00da95e76e234f3eda000000000000000100000000000000010000000000000020416bac3de0006da1798cae084cc883aa8b5725961532c3ea97397066834e91d200000000000000010000000000000001000000000000002045b30f8deef10851252d021c3e4dc088f7e506edec85716c0659e5c3bfce29e60000000000000009000000000000002034440d6630f9846b27bc05a32f3390d9b84831d6a1e98df9396ba8fc49acecd700000000000000040000000000000001000000000000000000000000000000208a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b000000000000000100000000000000010000000000000020385e8fcd637daa4c623919aa40f434d90aedfd1ea2ebfaca4c83ea08c15e89800000000000000001000000000000000100000000000000207953f3ef60faf5131eb4991f6573040c270ba2578405427e8f5c88ec41887ccb00000000000000010000000000000000000000000000002010608f5ebbec1730bdb054e8f1acd7438652f248f8c76b34911e296af867d2530000000000000001413fbbe66f8f303eaf3e1d12d93582acfa573fd38e94a3493eb9c605e9fbb6bb0000000000000020a74de21bd53d526f56e1b72cb5e9fd6b3552f4328478db514f3af23afe85290a0000000000000002000000000000000112b087a4e0e901a55d17a1c70f873be6caf042998a07ff674e47fcf7f45e0ea3000000000000000157a29aff227b762b201b4dc338ff6665c483042b89396ed78dff7dd9fceb131800000000000000010000000000000020823ab20226a4ddd6e5b05824b0e6a44697fe2d907f2a46d647dfd67776890b57000000000000000200000000000000010000000000000000000000000000002087f10652c4aa5cf3c9ebd0037211db5e7009f87dec108f6c8bb6141d20a15629000000000000000100000000000000010000000000000020960051d1769a803cc1903c9cc11e5e0c7b9fc2cf82714b07550bc79dd57fe999000000000000000200000000000000010000000000000020a74de21bd53d526f56e1b72cb5e9fd6b3552f4328478db514f3af23afe85290a0000000000000003000000000000000100000000000000000000000000000020d4d989de60f96bdc78c34eaefd8541dd578ec961901dfe38406c49995dd2a5a20000000000000001000000000000000100000000000000202549fb1684d4201e9b196ef91e45a909f817f164f214dd3219280dc46f0a22c200000000000000010000000000000001000000000000002085013d1f2744c0da4ecc4fd4bbe969efcb0f7f9a742415184e1408c3045cbf7300000000000000050000000000000020a74de21bd53d526f56e1b72cb5e9fd6b3552f4328478db514f3af23afe85290a00000000000000030000000000000001000000000000000000000000000000204a184698c428347c90667f1bc576dc42a08e8e9b32748c4c12e9163c59044f610000000000000001000000000000000100000000000000200d05e1d4d947d654b827a8be30ccca8cf90018f05790787ca736f298ca2a2aae00000000000000010000000000000000000000000000002046db96bc75bd4f1f73e384b432495bb48b6a252f721890e0235bc017f8fe0ec600000000000000014a3ca06fd412840b15a0499b93922ea461eeb4218369c634179a43108ceeb6f40000000000000020823ab20226a4ddd6e5b05824b0e6a44697fe2d907f2a46d647dfd67776890b5700000000000000020000000000000001413fbbe66f8f303eaf3e1d12d93582acfa573fd38e94a3493eb9c605e9fbb6bb0000000000000001112866914311959d78d09d3902a2b0138f60f2f67643d042bb1f354b7c03d7e20000000000000000000000000000002040589b81ff7f000005ba59000000000038589b81ff7f0000c05a9b81ff7f00000000000000000000000000000000000200000000000000010000000000000020823ab20226a4ddd6e5b05824b0e6a44697fe2d907f2a46d647dfd67776890b57000000000000000200000000000000010000000000000000000000000000002087f10652c4aa5cf3c9ebd0037211db5e7009f87dec108f6c8bb6141d20a15629000000000000000100000000000000010000000000000020960051d1769a803cc1903c9cc11e5e0c7b9fc2cf82714b07550bc79dd57fe99900000000000000030000000000000020823ab20226a4ddd6e5b05824b0e6a44697fe2d907f2a46d647dfd67776890b570000000000000002000000000000000100000000000000000000000000000020d72e7045dcca96dcf4c942cf0e1df4e2b269dea39482d903eb71607c044e1549000000000000000100000000000000000000000000000020259945022849f579249ec2927ad0c2e169b5bed4948ba7c2ad96bc3030a03c0a000000000000000100000000000000023ccf2df5f148d9f514761c7c63e2a2a414f746b2c5a09ccac1f24239cc5250c96db9f4c6fbc46e104a8ed14f940f5a91d20ffb81750e7dac227d6d189acabbfa000000000000000300000000000000016384862f23292318091cfaf33b2cab20af3fefc0fa7fd63d6b506892a995a27a000000000000002034440d6630f9846b27bc05a32f3390d9b84831d6a1e98df9396ba8fc49acecd7000000000000000200000000000000015a69273aee19dc15fc4d86fd5d1bc69422c898839a40e375a81526c424ac5108000000000000000123546505647e19581708d7d8ef9e5ef083afe699fff36cadf640cce8db9af21e000000000000000100000000000000209366162c92994e89cb49edae56266920cd873dbe88d1959f97291a270f5a4221000000000000000300000000000000010000000000000000000000000000002012a9cd11acad88276fc82805dee08be034e6671c979fb6c34871b446098fed93000000000000000100000000000000010000000000000020c45589c53ce59cb5ff935a38a0525ddf2cdfb14707aeb38e0d4f9f1df11e0c8e000000000000000100000000000000010000000000000020b848c2bef1e08830f45ab7ce9abd07b34b628bd939d1c3b2605bdc0b7253c8e600000000000000020000000000000009000000000000002034440d6630f9846b27bc05a32f3390d9b84831d6a1e98df9396ba8fc49acecd700000000000000040000000000000001000000000000000000000000000000208a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b000000000000000100000000000000010000000000000020385e8fcd637daa4c623919aa40f434d90aedfd1ea2ebfaca4c83ea08c15e89800000000000000001000000000000000100000000000000207953f3ef60faf5131eb4991f6573040c270ba2578405427e8f5c88ec41887ccb00000000000000010000000000000000000000000000002010608f5ebbec1730bdb054e8f1acd7438652f248f8c76b34911e296af867d2530000000000000001000000000000002034440d6630f9846b27bc05a32f3390d9b84831d6a1e98df9396ba8fc49acecd70000000000000004000000000000000100000000000000000000000000000020c6bb06cb7f92603de181bf256cd16846b93b752a170ff24824098b31aa008a7e0000000000000001000000000000000100000000000000204378ff515889172eba22524c734480b058f489537071dd00da95e76e234f3eda000000000000000100000000000000010000000000000020416bac3de0006da1798cae084cc883aa8b5725961532c3ea97397066834e91d200000000000000010000000000000001000000000000002045b30f8deef10851252d021c3e4dc088f7e506edec85716c0659e5c3bfce29e6000000000000000153bcfe339ef369aee80d2cb953036656ecad47615665d6fdf068bd7b9017425c00000000000000209366162c92994e89cb49edae56266920cd873dbe88d1959f97291a270f5a4221000000000000000200000000000000016384862f23292318091cfaf33b2cab20af3fefc0fa7fd63d6b506892a995a27a000000000000000142abb2f2da1a2e84e426a72454d39ba5debc977737768fb7031847616ad77f97000000000000000100000000000000204173ed2abfb2f4a0a7c9dbd974fa185eb2f4dc9903fb193323675a4f2a1d4f09000000000000000200000000000000010000000000000000000000000000002004103510e5b24aa68a34b9ff41bd39921b5012cbf270ee22846bba11fe54072c000000000000000100000000000000010000000000000020559fab42398fcdf19a55d6316917b723535bda293586de94aa555dc0e1187aa90000000000000002000000000000000100000000000000209366162c92994e89cb49edae56266920cd873dbe88d1959f97291a270f5a4221000000000000000300000000000000010000000000000000000000000000002012a9cd11acad88276fc82805dee08be034e6671c979fb6c34871b446098fed93000000000000000100000000000000010000000000000020c45589c53ce59cb5ff935a38a0525ddf2cdfb14707aeb38e0d4f9f1df11e0c8e000000000000000100000000000000010000000000000020b848c2bef1e08830f45ab7ce9abd07b34b628bd939d1c3b2605bdc0b7253c8e6000000000000000500000000000000209366162c92994e89cb49edae56266920cd873dbe88d1959f97291a270f5a422100000000000000030000000000000001000000000000000000000000000000208c927e149393ae621f59498d467e7c295bfda8880cbc7f57eb90b3799dcea19f0000000000000001000000000000000100000000000000201cacb68956b524ba08500155ad3b3bb8d73fdc565caa687995ce5a6d4b01fbf7000000000000000100000000000000000000000000000020a08afba31fd20c86b448d62df4d24b927c3bd634357d458eaf299649a4eced5d00000000000000014302e0821f21e92cfd212334d975201796a4ef3450907b1d9f74d520318794d000000000000000204173ed2abfb2f4a0a7c9dbd974fa185eb2f4dc9903fb193323675a4f2a1d4f090000000000000002000000000000000153bcfe339ef369aee80d2cb953036656ecad47615665d6fdf068bd7b9017425c000000000000000110182e744f2937f04684f666eaade9b9a9080f98f26d8cc26a74d8ed101be9400000000000000000000000000000002040589b81ff7f000005ba59000000000038589b81ff7f0000c05a9b81ff7f000000000000000000000000000000000002000000000000000100000000000000204173ed2abfb2f4a0a7c9dbd974fa185eb2f4dc9903fb193323675a4f2a1d4f09000000000000000200000000000000010000000000000000000000000000002004103510e5b24aa68a34b9ff41bd39921b5012cbf270ee22846bba11fe54072c000000000000000100000000000000010000000000000020559fab42398fcdf19a55d6316917b723535bda293586de94aa555dc0e1187aa9000000000000000300000000000000204173ed2abfb2f4a0a7c9dbd974fa185eb2f4dc9903fb193323675a4f2a1d4f090000000000000002000000000000000100000000000000000000000000000020165c85dd67521b01034c368a3bc8b4ca3805a0040a7e5c1b38bcf0e46d5d97520000000000000001000000000000000000000000000000205ab52c5a78f8ccece5d7c3a44d7a63f7e287f682a3eb8989072ccacaaacd875e'

    params['init_transcript'] = '0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'

    params['init_params'] = []
    params['init_params'].append(
        52435875175126190479447740508185965837690552500527637822603658699938581184513)
    params['init_params'].append(3)
    params['init_params'].append(15)
    params['init_params'].append(1)
    params['init_params'].append(2)
    D_omegas = []
    D_omegas.append(
        14788168760825820622209131888203028446852016562542525606630160374691593895118)
    D_omegas.append(
        23674694431658770659612952115660802947967373701506253797663184111817857449850)
    D_omegas.append(3465144826073652318776269530687742778270252468765361963008)
    params['init_params'].append(len(D_omegas))
    params['init_params'].extend(D_omegas)
    q = []
    q.append(0)
    q.append(0)
    q.append(1)
    params['init_params'].append(len(q))
    params['init_params'].extend(q)

    params['evaluation_points'] = [[7, ], ]

    return params


if __name__ == '__main__':
    compiled = solcx.compile_files(
        [f'{contracts_dir}/commitments/test/public_api_lpc_verification.sol'],
        output_values=['abi', 'bin'],
        solc_version="0.8.12",
        optimize=False,
        optimize_runs=None)
    compiled_id, compiled_interface = find_compiled_contract(compiled, contract_name)
    bytecode = compiled_interface['bin']
    abi = compiled_interface['abi']
    print('Bytecode size:', len(bytecode) // 2)

    contract = w3.eth.contract(abi=abi, bytecode=bytecode)
    deploy_tx_hash = contract.constructor().transact()
    deploy_tx_receipt = w3.eth.wait_for_transaction_receipt(deploy_tx_hash)
    contract_inst = w3.eth.contract(
        address=deploy_tx_receipt.contractAddress, abi=abi)
    params = init_test1()
    run_tx_hash = contract_inst.functions.batched_verify(
        params['proof'], params['init_transcript'], params['init_params'], params['evaluation_points']).transact()
    run_tx_receipt = w3.eth.wait_for_transaction_receipt(run_tx_hash)

    print_tx_info(w3, run_tx_receipt, params['_test_name'])

